<h1>SHIELD v2 API</h1>

<p>This document specifies the behavior of the SHIELD API, version 2,
in its entirety.  This is a specification, not merely
documentation &mdash; it is the authoritative source.  If this
document is unclear, it will be amended.  If the SHIELD codebase
disagrees with this specification, the code is incorrect and
should be treated as such.</p>

<p>The purpose of this document is to allow 3rd party integrators to
inter-operate with the SHIELD API without resorting to spelunking
through its implementation.</p>

<h2>Error Handling</h2>

<p>The SHIELD API returns errors by using non-200 HTTP status codes,
as follows:</p>

<ul>
<li><p><strong>500</strong> - An internal error has occurred; details will be
present in the SHIELD Core server error log.  The response
will contain a sanitized error message, using the standard
format (described below).</p></li>
<li><p><strong>400</strong> - Something about the HTTP request was invalid or
incorrect.  This may occur if a JSON payload was expected,
but not provided, required keys in theat payload were missing,
or values supplied were incorrect, out-of-range, etc.</p></li>
<li><p><strong>404</strong> - The requested resource was not found.  An error
(in the standard format) will be returned.</p></li>
<li><p><strong>401</strong> - The requester is not authenticated to the SHIELD
API, but has requested a protected endpoint.  The request
may be retried after authenticating.</p></li>
<li><p><strong>403</strong> - The requester is authenticated but has requested
an endpoint that they do lack the rights to access.  This
request should not be retried.</p></li>
</ul>

<p>Regardless of the HTTP status code used, the SHIELD API will
always include a JSON payload with more details, in either the
<strong>Standard Format</strong> or the <strong>Missing Values Format</strong>.</p>

<h3>Standard Format for Error Reporting</h3>

<p>The <strong>Standard Format</strong> for error reporting consists of a
top-level JSON object containing a single key, <code>error</code>, that
contains a human-readable error message, suitable for display.</p>

<p>Example:</p>

<pre><code>{
  "error": "No such retention policy"
}
</code></pre>

<p>This format is used for all non-validation error reporting.</p>

<h3>Missing Values Format for Error Reporting</h3>

<p>The <strong>Missing Values Format</strong> for error reporting is used for
reporting request validation errors where required fields in the
request payload are missing.  It consists of a top-level JSON
object containing a single key, <code>missing</code>, which is set to a list
of field names that must be sent in the request, but were not.</p>

<p>Example:</p>

<pre><code>{
  "missing": [
    "name",
    "endpoint",
    "agent"
  ]
}
</code></pre>

<p>The order of the fields is inconsequential.</p>

<h2>Health &amp; Informational</h2>

<p>The health and informational endpoints give you a glimpse into the
well-being of a SHIELD Core, for monitoring purposes, at various
levels of detail.</p>

<h3>GET /v2/info</h3>

<p>Returns minimal information necessary for forward-compatibility
with different versions of SHIELD Core and clients.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/info
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "version" : "6.7.2",
  "env"     : "PRODUCTION",
  "color"   : "yellow",
  "motd"    : "Welcome to S.H.I.E.L.D.",
  "ip"      : "10.0.0.5",
  "api"     : 2
}
</code></pre>

<p>The <code>version</code> key only shows up if the request was made in the
context of an authenticated session.</p>

<p>The <code>env</code> key is configurable by the SHIELD site administrator,
at deployment / boot time.</p>

<p>Similar to env, the <code>color</code> key is configurable by the SHIELD site
administrator, used to visually differentiate various SHIELD
deployments in the WebUI.</p>

<p>The <code>motd</code> is what is displayed upon login, and can be changed by
the SHIELD site administrator.</p>

<p>The <code>ip</code> key is the ip of the SHIELD core.</p>

<p>The <code>api</code> key is a single integer that identifies which version
of the SHIELD API this core implements.  Currently, there are
two possible values:</p>

<ul>
<li><strong>2</strong> - The <code>/v2</code> endpoints are present, but not <code>/v1</code></li>
<li><strong>1</strong> - Only the <code>/v1</code> endpoints are present (legacy).</li>
</ul>

<p><strong>Access Control</strong></p>

<p>This endpoint requires no authentication or authorization.</p>

<p><strong>Errors</strong></p>

<p>This API endpoint does not return any error conditions.</p>

<h3>GET /v2/bearings</h3>

<p>Returns a baseline set of information about the data related to the
current session's view of SHIELD, including targets, jobs, stores for
all assigned tenants, and global storage.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/bearings
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "vault"  : "unlocked",
  "shield" : {
    "version" : "6.7.2",
    "env"     : "PRODUCTION",
    "color"   : "yellow",
    "motd"    : "Welcome to S.H.I.E.L.D.",
    "ip"      : "10.0.0.5",
    "api"     : 2
  },

  "user" : {
    "uuid"           : "229db66f-ad6b-40ee-b0c9-36b3eb957503",
    "name"           : "Persephone Jones",
    "account"        : "pjones",
    "backend"        : "local",
    "sysrole"        : "technician",
    "default_tenant" : "c76869df-3535-4a59-b33b-2f650e660bf1"
  },

  "stores": [
    {
      "uuid"    : "8f4dd8c4-9677-4660-ad53-b0a5b718628c",
      "name"    : "Global Storage",
      "summary" : "Global Storage, for use by any and all",
      "global"  : true,

      "agent"  : "127.0.0.1:5444",
      "plugin" : "webdav",

      "healthy"        : true,
      "archive_count"  : 0,
      "storage_used"   : 0,
      "threshold"      : 0,
      "daily_increase" : 0,

      "config": {
        "url": "http://localhost:8182"
      },

      "last_test_task_uuid": ""
    }
  ],

  "tenants" : {
    "c76869df-3535-4a59-b33b-2f650e660bf1" : {
      "tenant" : {
        "uuid"           : "c76869df-3535-4a59-b33b-2f650e660bf1",
        "name"           : "My Tenant",
        "archive_count"  : 0,
        "storage_used"   : 0,
        "daily_increase" : 0
      },

      "role"   : "admin",
      "grants" : {
        "admin"    : true,
        "engineer" : true,
        "operator" : true
      },

      "archives": [],
      "jobs": [
        {
          "uuid"      : "c623b8bf-b631-43ee-bb44-949454702716",
          "name"      : "Hourly",
          "summary"   : "",

          "keep_n"    : 48,
          "keep_days" : 2,

          "schedule"  : "hourly at :05",
          "paused"    : true,

          "agent"     : "127.0.0.1:5444",
          "fixed_key" : false,

          "healthy"          : false,
          "last_run"         : 1543328457,
          "last_task_status" : "canceled",

          "target" : {
            "uuid" : "5c180612-05e8-4ae6-9046-9d40d50d1a3c",
            "name" : "SHIELD",

            "agent"  : "",
            "plugin" : "fs",

            "compression" : "bzip2",
            "endpoint"    : "{\"base_dir\":\"/e/no/ent\",\"bsdtar\":\"bsdtar\",\"exclude\":\"var/*.db\"}"
          },
          "store" : {
            "uuid"     : "a5d64d9e-acc7-4621-8489-2ede2d3b31bf",
            "name"     : "CloudStor",
            "summary"  : "A temporary store for the dev environment.",

            "healthy"  : true,

            "agent"    : "",
            "plugin"   : "webdav",
            "endpoint" : "{\"url\":\"http://localhost:8182\"}"
          }
        }
      ],

      "targets" : [
        {
          "uuid"    : "5c180612-05e8-4ae6-9046-9d40d50d1a3c",
          "name"    : "SHIELD",
          "summary" : "The working directory of the dev environment.",

          "compression" : "bzip2",

          "agent"  : "127.0.0.1:5444",
          "plugin" : "fs",
          "config" : {
            "base_dir" : "/e/no/ent",
            "bsdtar"   : "bsdtar",
            "exclude"  : "var/*.db"
          }
        }
      ],

      "stores" : [
        {
          "uuid"    : "a5d64d9e-acc7-4621-8489-2ede2d3b31bf",
          "name"    : "CloudStor",
          "summary" : "A temporary store for the dev environment.",
          "global"  : false,

          "healthy"        : true,
          "archive_count"  : 0,
          "storage_used"   : 0,
          "daily_increase" : 0,
          "threshold"      : 0,

          "agent"   : "127.0.0.1:5444",
          "plugin"  : "webdav",
          "config"  : {
            "url": "http://localhost:8182"
          },

          "last_test_task_uuid": "4320b06d-dd3d-4c00-a2cd-9fec9b2520d6"
        }
      ]
    }
  }
}
</code></pre>

<p>FIXME</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</li>
</ul>

<h3>GET /v2/health</h3>

<p>Returns health information about the SHIELD Core, connected
storage accounts, and general metrics, at a global scope.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/health
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<p>If all goes well, you will receive a 200 OK, with a <code>Content-Type</code>
of <code>application/json</code>, and something similar to the following JSON
payload in the response body:</p>

<pre><code>{
  "health": {
    "core"       : "unsealed",
    "storage_ok" : true,
    "jobs_ok"    : true
  },
  "storage": [
    { "name": "s3", "healthy": true },
    { "name": "fs", "healthy": true } ],
  "jobs": [
    {
      "uuid"    : "3dc875a4-042c-47a1-828c-1d927455c6c7",
      "target"  : "BOSH DB",
      "job"     : "daily",
      "healthy" : true
    },
    {
      "uuid"    : "d9a4547e-c1e7-4869-bb8d-4abb757b2f70",
      "target"  : "BOSH DB",
      "job"     : "weekly",
      "healthy" : true
    }
  ],
  "stats": {
    "jobs"    : 8,
    "systems" : 7,
    "archives": 124,
    "storage" : 243567112,
    "daily"   : 12345000
  }
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to check SHIELD health</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
</ul>

<h3>GET /v2/tenants/:tenant/health</h3>

<p>Returns health information about the SHIELD Core, connected
storage accounts, and general metrics, restricted to the scope
visible to a single tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/health
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<p>If all goes well, you will receive a 200 OK, with a <code>Content-Type</code>
of <code>application/json</code>, and something similar to the following JSON
payload in the response body:</p>

<pre><code>{
  "health": {
    "core"       : "unsealed",
    "storage_ok" : true,
    "jobs_ok"    : true
  },
  "storage": [
    { "name": "s3", "healthy": true },
    { "name": "fs", "healthy": true } ],
  "jobs": [
    {
      "uuid"    : "3dc875a4-042c-47a1-828c-1d927455c6c7",
      "target"  : "BOSH DB",
      "job"     : "daily",
      "healthy" : true
    },
    {
      "uuid"    : "d9a4547e-c1e7-4869-bb8d-4abb757b2f70",
      "target"  : "BOSH DB",
      "job"     : "weekly",
      "healthy" : true
    }
  ],
  "stats": {
    "jobs"    : 8,
    "systems" : 7,
    "archives": 124,
    "storage" : 243567112,
    "daily"   : 12345000
  }
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to check SHIELD health</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h2>SHIELD Authentication</h2>

<p>The Authentication endpoints allow clients to authenticate to a
SHIELD Core, providing credentials to prove their identity and
their authorization to perform other tasks inside of SHIELD.</p>

<h3>POST /v2/auth/login</h3>

<p>Authenticate against the SHIELD API as a local user, and retrieve
a session ID that can be used for future, authenticated,
interactions.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/auth/login \
     --data-binary '
{
  "username": "your-username",
  "password": "your-password"
}'
</code></pre>

<p><strong>NOTE:</strong> <code>password</code> is sent in cleartext, so SHIELD should aways be
communicating over TLS (HTTPS).</p>

<p>Both fields, <code>username</code>, and <code>password</code>, are required.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "95cca9ea-d2e6-4966-b071-9df6856a0e55"
}
</code></pre>

<p>The session ID (return under the <code>ok</code> key) should be passed on
subsequent requests as proof of authentication.  This can be done
by setting the <code>shield7</code> cookie to the session ID, or by setting
the <code>X-Shield-Session</code> request header.</p>

<p><strong>Access Control</strong></p>

<p>This endpoint requires no authentication or authorization.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to log you in</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Incorrect username or password</strong>:
The supplied credentials were incorrect; either the
user doesn't exist, or the password was wrong.</p></li>
</ul>

<h3>GET /v2/auth/logout</h3>

<p>Destroy the current session and log the user out.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/auth/logout
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok" : "Successfully logged out"
}
</code></pre>

<p><strong>NOTE:</strong> The same behavior is exhibited when an authenticated
session successfully logs out, as is seen when an unauthenticated
session attempts to log out.</p>

<p><strong>Access Control</strong></p>

<p>This endpoint requires no authentication or authorization.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><strong>Unable to log you out</strong>:
an internal error occurred and should be investigated by the
site administrators</li>
</ul>

<h3>GET /v2/auth/id</h3>

<p>Retrieve identity and authorization information about the
currently authenticated session.  If the requester has not
authenticated, a suitable response will be returned.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/auth/id
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "user": {
    "name"    : "Your Full Name",
    "account" : "username",
    "backend" : "SHIELD",
    "sysrole" : ""
  },
  "tenants": [
    {
      "uuid": "63a8f402-31e6-4503-8fab-66cbcf411ed3",
      "name": "Some Random Tenant",
      "role": "admin"
    },
    {
      "uuid": "860f7685-c311-4ae5-b34d-6991fc721a37",
      "name": "Another Tenant",
      "role": "engineer"
    }
  ],
  "tenant": {
    "uuid": "63a8f402-31e6-4503-8fab-66cbcf411ed3",
    "name": "Some Random Tenant",
    "role": "admin"
  }
}
</code></pre>

<p>The top-level <code>user</code> key contains information about the current
authenticated user, including their name and what authentication
provider they came from.</p>

<p>The <code>tenants</code> key lists <em>all</em> of the tenants that this user
belongs to, along with the role assigned on each.  The session is
free to switch between any of these tenants as they see fit.</p>

<p>The <code>tenant</code> key contains the tenant definition for the currently
selected tenant, based on user preferences.</p>

<p><strong>Access Control</strong></p>

<p>This endpoint requires no authentication or authorization.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><strong>Authentication failed</strong>:
The request either lacked a session cookie (or an
<code>X-Shield-Session</code> header), or some other internal
error has occurred, and SHIELD administrators should
investigate.</li>
</ul>

<h3>GET /v2/auth/providers</h3>

<p>Retrieve public configuration of SHIELD Authentication Providers,
which can be used by client systems to initiate authentication
against 3rd party systems like Github and Cloud Foundry UAA.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/auth/providers
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "name"       : "Github(.com)",
    "identifier" : "gh",
    "type"       : "github",

    "web_entry"  : "/auth/gh/web",
    "cli_entry"  : "/auth/gh/cli",
    "redirect"   : "/auth/gh/redir"
  }
]
</code></pre>

<p><strong>Access Control</strong></p>

<p>This endpoint requires no authentication or authorization.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</li>
</ul>

<h3>GET /v2/auth/providers/:identifier</h3>

<p>Retrieve private configuration of a single SHIELD Authentication
Providers, for use by SHIELD administrators.  This includes all of
the information from the public endpoint, as well as private
properties including things like client secrets.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/auth/providers/:identifier
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "name"       : "Github(.com)",
  "identifier" : "gh",
  "type"       : "github",

  "web_entry"  : "/auth/gh/web",
  "cli_entry"  : "/auth/gh/cli",
  "redirect"   : "/auth/gh/redir",

  "properties" : {
    "secret"   : "properties",
    "that"     : "are",
    "provider" : "specific"
  }
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>admin</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>No such authentication provider</strong>:
No authentication provider was found with the given
identifier.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/auth/tokens</h3>

<p>Retrieve a list of all authentication tokens that have been
generated for use on behalf of the currently authenticated
user.  For security reasons, the session ID attached to the
authentication token is not returned.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/auth/tokens
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid"       : "bbcb6675-8ec4-4412-93e3-35626860b126",
    "name"       : "test",
    "created_at" : "2017-10-21 00:54:33",
    "last_seen"  : null
  }
]
</code></pre>

<p>The <code>uuid</code> key is used strictly for retrieving and revoking each
authentication token; it cannot be used as an authentication token,
as it is not the session ID.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Authentication failed</strong>:
The request either lacked a session cookie (or an
<code>X-Shield-Session</code> header), or some other internal
error has occurred, and SHIELD administrators should
investigate.</p></li>
<li><p><strong>Unable to retrieve tokens information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
</ul>

<h3>POST /v2/auth/tokens</h3>

<p>Generate a new authentication token to act on behalf of the
currently authenticated user.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/auth/tokens \
     --data-binary '
{
  "name": "auth-token-name"
}'
</code></pre>

<p>Each authentication token requires a name that is unique
to the parent user account.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"       : "bbcb6675-8ec4-4412-93e3-35626860b126",
  "session"    : "8ef409e9-690d-4d91-9f74-6d657f56843e",
  "name"       : "test",
  "created_at" : "2017-10-21 00:54:33",
  "last_seen"  : null
}
</code></pre>

<p>The <code>uuid</code> key is used strictly for retrieving and revoking each
authentication token; it cannot be used as an authentication token,
as it is not the session ID.</p>

<p>The <code>session</code> key should be used</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Authentication failed</strong>:
The request either lacked a session cookie (or an
<code>X-Shield-Session</code> header), or some other internal
error has occurred, and SHIELD administrators should
investigate.</p></li>
<li><p><strong>Unable to retrieve tokens information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to generate new token</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
</ul>

<h3>DELETE /v2/auth/tokens/:uuid</h3>

<p>Revoke an authentication token that belongs to the currently
authenticated user (even if its authenticated by the token being
revoked).</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/auth/tokens/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Token revoked"
}
</code></pre>

<p>Note that if you have revoked the auth token you were using, all
subsequent requests will fail to authenticated.  It makes sense,
but it bears repeating.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to revoke auth token</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
</ul>

<h3>GET /v2/auth/sessions</h3>

<p>Retrieve a list of all current login sessions</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/auth/sessions
</code></pre>

<ul>
<li><p><strong>?exact=(t|f)</strong>
When filtering sessions, perform either exact field / value
matching (<code>exact=t</code>), or fuzzy search (<code>exact=f</code>, the
default)</p></li>
<li><p><strong>?is_token=(t|f)</strong>
When filtering sessions, include those associated with tokens (default - false)</p></li>
<li><p><strong>?uuid=</strong>
Only show the session that matches the given UUID.
This is a FIXME - we probably need to remove this.</p></li>
<li><p><strong>?user_uuid=</strong>
Only show sessions that matches the given user UUID.</p></li>
<li><p><strong>?name=...</strong>
Only show sessions whose associated token name match the given value.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?ip_addr=...</strong>
Only show sessions who are associated with the given IP address.</p></li>
<li><p><strong>?limit=N</strong>
Limit the returned result set to the first <em>limit</em> users
that match the other filtering rules.  A limit of <code>0</code> (the
default) denotes an unlimited search.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid": "cbeffb8d-4d3d-49a1-b4cd-14b344dac1f2",
    "user_uuid": "ccc0430b-9d3d-4b1c-a980-dac769f64174",
    "created_at": "2017-10-24 16:39:03",
    "last_seen_at": "2017-10-24 16:39:03",
    "token_uuid": "",
    "name": "",
    "ip_addr": "127.0.0.1",
    "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36",
    "user_account": "admin",
    "current_session": false
  }
]
</code></pre>

<ul>
<li><p><strong>uuid</strong> - The internal UUID assigned to this session by the SHIELD Core.</p></li>
<li><p><strong>user_uuid</strong> - The internal UUID corresponding to the user associated with the session.</p></li>
<li><p><strong>created_at</strong> - When the user created the session (upon login via WebUI or CLI).
Date is formatted YYYY-MM-DD HH:MM:SS, in 24-hour notation.</p></li>
<li><p><strong>last_seen_at</strong> - When the user last made contact with the
SHIELD Core via an authenticated endpoint.
Date is formatted YYYY-MM-DD HH:MM:SS, in 24-hour notation.</p></li>
<li><p><strong>token_uuid</strong> - The uuid of the SHIELD Token associated with the session (if applicable).</p></li>
<li><p><strong>name</strong> - The name of the SHIELD Token associated with the session (if applicable).</p></li>
<li><p><strong>ip_addr</strong> - The originating <code>IP address</code> of the user, from the
point-of-view of the SHIELD Core.</p></li>
<li><p><strong>user_agent</strong> - The user agent associated with the last request made by the user.</p></li>
<li><p><strong>user_account</strong> - The account corresponding to the user associated with the session.</p></li>
<li><p><strong>current_session</strong> - Denotes whether the session corresponds to the requesting session.</p></li>
</ul>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>admin</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Authentication failed</strong>:
The request either lacked a session cookie (or an
<code>X-Shield-Session</code> header), or some other internal
error has occurred, and SHIELD administrators should
investigate.</p></li>
<li><p><strong>Unable to retrieve session information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/auth/sessions/:uuid</h3>

<p>Retrieve a single login session</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/auth/sessions/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid": "cbeffb8d-4d3d-49a1-b4cd-14b344dac1f2",
  "user_uuid": "ccc0430b-9d3d-4b1c-a980-dac769f64174",
  "created_at": "2017-10-24 16:39:03",
  "last_seen_at": "2017-10-24 16:39:03",
  "token_uuid": "",
  "name": "",
  "ip_addr": "127.0.0.1",
  "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36",
  "user_account": "admin"
}
</code></pre>

<ul>
<li><p><strong>uuid</strong> - The internal UUID assigned to this session by the SHIELD Core.</p></li>
<li><p><strong>user_uuid</strong> - The internal UUID corresponding to the user associated with the session.</p></li>
<li><p><strong>created_at</strong> - When the user created the session (upon login via WebUI or CLI).
Date is formatted YYYY-MM-DD HH:MM:SS, in 24-hour notation.</p></li>
<li><p><strong>last_seen_at</strong> - When the user last made contact with the
SHIELD Core via an authenticated endpoint.
Date is formatted YYYY-MM-DD HH:MM:SS, in 24-hour notation.</p></li>
<li><p><strong>token_uuid</strong> - The uuid of the SHIELD Token associated with the session (if applicable).</p></li>
<li><p><strong>name</strong> - The name of the SHIELD Token associated with the session (if applicable).</p></li>
<li><p><strong>ip_addr</strong> - The originating <code>IP address</code> of the user, from the
point-of-view of the SHIELD Core.</p></li>
<li><p><strong>user_agent</strong> - The user agent associated with the last request made by the user.</p></li>
<li><p><strong>user_account</strong> - The account corresponding to the user associated with the session.</p></li>
</ul>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>admin</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Authentication failed</strong>:
The request either lacked a session cookie (or an
<code>X-Shield-Session</code> header), or some other internal
error has occurred, and SHIELD administrators should
investigate.</p></li>
<li><p><strong>Unable to retrieve session information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/auth/sessions/:uuid</h3>

<p>Revoke a user's session and force them to reauthenticate on next request.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/auth/sessions/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Successfully cleared session 'd3092979-5a83-4006-8819-fd1695f9041f' (127.0.0.1)"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>admin</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Session not found</strong>:
The session given by the URL UUID was not found in the database</p></li>
<li><p><strong>Unable to clear session</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to retrieve session information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>PATCH /v2/auth/user/settings</h3>

<p>Save user settings.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X PATCH https://shield.host/v2/auth/user/settings \
     --data-binary '
{
  "default_tenant": "2a03d67b-6146-4716-b10a-42ec073cfb78"
}'
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok" : "Settings saved."
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Authentication failed</strong>:
The request either lacked a session cookie (or an
<code>X-Shield-Session</code> header), or some other internal
error has occurred, and SHIELD administrators should
investigate.</p></li>
<li><p><strong>Unable to save settings</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
</ul>

<h2>SHIELD Users</h2>

<p>SHIELD provides both a local user database, and the ability to
map 3rd party systems into the SHIELD tenancy model.  These API
endpoints allow you to manage the former, and query the results
of the latter.</p>

<h3>GET /v2/auth/local/users</h3>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/auth/local/users
</code></pre>

<ul>
<li><p><strong>?exact=(t|f)</strong>
When filtering users, perform either exact field / value
matching (<code>exact=t</code>), or fuzzy search (<code>exact=f</code>, the
default)</p></li>
<li><p><strong>?uuid=</strong>
Only show the local user that matches the given UUID.
This is a FIXME - we probably need to remove this.</p></li>
<li><p><strong>?account=...</strong>
Only show local users whose account names (usernames)
match the given value.  Subject to the <code>exact=(t|f)</code> query
string parameter.</p></li>
<li><p><strong>?sysrole=...</strong>
Only show local users who have been assigned the given
system role.</p></li>
<li><p><strong>?limit=N</strong>
Limit the returned result set to the first <em>limit</em> users
that match the other filtering rules.  A limit of <code>0</code> (the
default) denotes an unlimited search.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid"       : "b30bb2dd-81d4-407f-91eb-a82ed3023218",
    "name"       : "Full Name",
    "account"    : "username",
    "sysrole"    : "engineer",

    "tenants": [
      {
        "uuid" : "d1fb6abf-55f2-4901-9662-8c6339e0a7d7",
        "name" : "Tenant Name",
        "role" : "operator"
      }
    ]
  }
]
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Invalid limit parameter given</strong>:
Request specified a <code>limit</code> parameter that was either
non-numeric, or was negative.  Note that <code>0</code> is a valid limit,
standing for <em>unlimited</em>.</p></li>
<li><p><strong>Unable to retrieve local users information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/auth/local/users/:uuid</h3>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/auth/local/users/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"       : "b30bb2dd-81d4-407f-91eb-a82ed3023218",
  "name"       : "Full Name",
  "account"    : "username",
  "sysrole"    : "engineer",

  "tenants": [
    {
      "uuid" : "d1fb6abf-55f2-4901-9662-8c6339e0a7d7",
      "name" : "Tenant Name",
      "role" : "operator"
    }
  ]
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve local user information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>user '...' not found (for local auth provider)</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/auth/local/users</h3>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/auth/local/users \
     --data-binary '
{
  "name"     : "Full Name",
  "account"  : "username",
  "password" : "cleartext password",
  "sysrole"  : "engineer"
}'
</code></pre>

<p>The <code>sysrole</code> parameter must be either empty (or not specified),
or one of the following values: <strong>admin</strong>, <strong>engineer</strong>, or
<strong>operator</strong>.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"       : "b30bb2dd-81d4-407f-91eb-a82ed3023218",
  "name"       : "Full Name",
  "account"    : "username",
  "sysrole"    : "engineer"
}
</code></pre>

<p><strong>NOTE</strong> that the user's password (neither in hashed form, or in
the clear) is never returned to requesters.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>System role '...' is invalid</strong>:
Request specified a <code>sysrole</code> payload parameter that was
outside of the allowable set of values.</p></li>
<li><p><strong>Unable to create local user '...'</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>User '...' already exists</strong>:
You attempted to create a new local user account, but the
username was already assigned to a pre-existing account.
The request should not be retried.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>PATCH /v2/auth/local/users/:uuid</h3>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X PATCH https://shield.host/v2/auth/local/users/:uuid \
     --data-binary '
{
  "name"     : "Full Name",
  "password" : "cleartext password",
  "sysrole"  : "engineer"
}'
</code></pre>

<p>The <code>sysrole</code> parameter must be either empty (or not specified),
or one of the following values: <strong>admin</strong>, <strong>engineer</strong>, or
<strong>operator</strong>.</p>

<p><strong>NOTE</strong> that you cannot alter a users <code>account</code> after creation.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"       : "b30bb2dd-81d4-407f-91eb-a82ed3023218",
  "name"       : "Full Name",
  "account"    : "username",
  "sysrole"    : "engineer"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>No such local user</strong>:
Either the user given by the URL UUID was not found in the
database, or that user was created by an authentication
provider, and not SHIELD itself.</p></li>
<li><p><strong>System role '...' is invalid</strong>:
Request specified a <code>sysrole</code> payload parameter that was
outside of the allowable set of values.</p></li>
<li><p><strong>Unable to update local user '...'</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/auth/local/users/:uuid</h3>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/auth/local/users/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok" : "Successfully deleted local user"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Local User '...' not found</strong>:
Either the user given by the URL UUID was not found in the
database, or that user was created by an authentication
provider, and not SHIELD itself.</p></li>
<li><p><strong>Unable to retrieve local user information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to delete local user '...'</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h2>SHIELD Core</h2>

<p>These endpoints allow clients to initialize brand new SHIELD
Cores, and unlock or rekey existing ones.</p>

<h3>POST /v2/init</h3>

<p>Initializes a new SHIELD Core, to set up the encryption facilities
for storing backup archive encryption keys safely and securely.
Your SHIELD Core can only be initialized once.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/init \
     --data-binary '
{
  "master" : "your secret master password"
}'
</code></pre>

<p>Where:</p>

<ul>
<li>message: master is the plaintext master password
to use for encrypting the credentials to the
SHIELD Core storage vault.</li>
</ul>

<p><strong>Response</strong></p>

<p>If all went well, and the SHIELD Core was properly initialized,
you will receive a 200 OK, and the following response:</p>

<pre><code>{
  "ok" : "Successfully initialized the SHIELD Core"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>This endpoint requires no authentication or authorization.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to initialize the SHIELD Core</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>This SHIELD Core has already been initialized</strong>:
You are attempting to re-initialize a SHIELD Core,
which is not allowed.</p></li>
</ul>

<h3>POST /v2/unlock</h3>

<p>Unlocks a SHIELD Core by providing the master password.  This
allows SHIELD to decrypt the keys to access its storage vault and
generate / retrieve backup archvie encryption keys safely and
securely.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/unlock \
     --data-binary '
{
  "master" : "your secret master password"
}'
</code></pre>

<ul>
<li>message: master is the plaintext master password
that was created when you initialized this SHIELD
Core (or whatever you last rekeyed it to be).</li>
</ul>

<p><strong>Response</strong></p>

<p>On success, you will receive a 200 OK, with the
following response:</p>

<pre><code>{
  "ok" : "Successfully unlocked the SHIELD Core"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>This endpoint requires no authentication or authorization.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to unlock the SHIELD Core</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>This SHIELD Core has not yet been initialized</strong>:
You may re-attempt this request after initializing
the SHIELD Core.</p></li>
</ul>

<h3>POST /v2/rekey</h3>

<p>Changes the master password used for encrypting the credentials
for the SHIELD Core storage vault (where backup archive encryption
keys are held).</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/rekey \
     --data-binary '
{
  "current" : "your CURRENT master password",
  "new"     : "what you want to change it to"
}'
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<p>If all goes well, you will receive a 200 OK, and the
following response:</p>

<pre><code>{
  "ok" : "Successfully rekeyed the SHIELD core"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>This endpoint requires no authentication or authorization.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><strong>Unable to rekey the SHIELD Core</strong>:
an internal error occurred and should be investigated by the
site administrators</li>
</ul>

<h2>SHIELD Agents</h2>

<p>These endpoints expose information about registered SHIELD Agents.</p>

<h3>GET /v2/agents</h3>

<p>Retrieves information about all registered SHIELD Agents.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/agents
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "agents": [
    {
      "name"         : "prod/web/42",
      "uuid"         : "1869e296-4aac-4a17-848d-04f73f743326",
      "address"      : "127.0.0.1:5444",
      "version"      : "dev",
      "status"       : "ok",
      "hidden"       : false,
      "last_error"   : "",
      "last_seen_at" : "2017-10-11 18:54:00"
    }
  ],
  "problems": {
    "1869e296-4aac-4a17-848d-04f73f743326": [
      "This SHIELD agent is reporting ..."
    ]
  }
}
</code></pre>

<p>The top-level <code>agents</code> key is a list of object describing each registered agent:</p>

<ul>
<li><p><strong>name</strong> - The name of the SHIELD Agent, as set by
the local system administrator (which may not be the
SHIELD site administrator).</p></li>
<li><p><strong>uuid</strong> - The internal UUID assigned to this agent by the SHIELD Core.</p></li>
<li><p><strong>address</strong> - The <code>host:port</code> of the agent, from the
point-of-view of the SHIELD Core.</p></li>
<li><p><strong>version</strong> - The version of the remote SHIELD Agent's software.</p></li>
<li><p><strong>status</strong> - The health status of the remote SHIELD
Agent, one of <code>ok</code> or <code>failing</code>.</p></li>
<li><p><strong>hidden</strong> - Whether or not this agent has been administratively hidden.</p></li>
<li><p><strong>last_error</strong> - TBD</p></li>
<li><p><strong>last_seen_at</strong> - When the remote SHIELD Agent last
made contact with the SHIELD Core to refresh its
registration and its metadata.  Date is formatted
YYYY-MM-DD HH:MM:SS, in 24-hour notation.</p></li>
</ul>

<p>The top-level <code>problems</code> key maps agent UUIDs to a list of errors detected
statically by the SHIELD Core software.  Each problem is represented as an
English-language description of the underlying issue.  SHIELD reports these
problems to assist site administrators who may be running heterogenous
versions of the SHIELD Core and SHIELD Agent software.  In these
environments, issues may arise due to version incompatibility.  Newer
versions of the SHIELD Core may also be able to inform administrators about
known deficiencies in older version of the SHIELD Agent and SHIELD plugins.</p>

<p><strong>NOTE:</strong> <code>problems</code> are reported by the SHIELD Core; it is perfectly
acceptable for an agent to report itself as healthy, but for the SHIELD Core
to assert that a problem exists.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>admin</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve agent information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/agents</h3>

<p>Initiate agent registration.  The client must supply a POST body
with the details of the agent being registered.</p>

<p>Once an agent has pre-registered, the SHIELD Core will schedule a
"pingback" task, connecting to the agent using its remote peer
address (from the registration HTTP conversation) and the given
port.  This pingback occurs via the SSH protocol, with an op type
of "ping".  The agent must respond with the same <em>name</em> that it
sent in the registration.</p>

<p>This exchange allows the SHIELD to validate registration requests,
using a weak form of authentication.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/agents \
     --data-binary '
{
  "name" : "some-identifier",
  "port" : 5444
}'
</code></pre>

<p>Where:</p>

<ul>
<li>message: name is the name of the agent to display in
the backend, and in log messages.  Usually, an FQDN
or other unique host identifier is preferable here.</li>
<li>message: port is the port number that the SHIELD
agent is bound to.  The remote peer IP will be
determined from the HTTP request's peer address.</li>
</ul>

<p><strong>Response</strong></p>

<p>On success, you will receive a 200 OK, and the following response:</p>

<pre><code>{
  "ok" : "Pre-registered agent &lt;name&gt; at &lt;host&gt;:&lt;port&gt;"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>This endpoint requires no authentication or authorization.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>No `name' provided with pre-registration request</strong>:
Your request was missing the required <code>name</code>
argument.  Re-attempt with the <code>name</code> argument.</p></li>
<li><p><strong>No `port' provided with pre-registration request</strong>:
Your request was missing the required <code>port</code>
argument.  Re-attempt with the <code>port</code> argument.</p></li>
<li><p><strong>Unable to pre-register agent \<name\> at \<host\>:\<port\></strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to determine remote peer address from '\<peer\>'</strong>:
SHIELD was unable to parse the HTTP connection's
peer address as a valid IP address.  This should be
investigated by the site administrators, your local
network administrator, and possibly the SHIELD
development team.</p></li>
</ul>

<h3>GET /v2/agents/:uuid</h3>

<p>Retrieve extended information about a single SHIELD Agent, including its
plugin metadata (what plugins are present, what configuration they accept or
require, etc.)</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/agents/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "agent": {
    "name"         : "prod/web/42",
    "uuid"         : "1869e296-4aac-4a17-848d-04f73f743326",
    "address"      : "127.0.0.1:5444",
    "version"      : "dev",
    "status"       : "ok",
    "hidden"       : false,
    "last_error"   : "",
    "last_seen_at" : "2017-10-11 18:54:00"
  },
  "metadata": {
    "name"    : "prod/web/42",
    "version" : "dev",
    "health"  : "ok",

    "plugins": {
      "fs": {
        "author"   : "shieldproject",
        "features" : {
          "store"  : "yes",
          "target" : "no"
        },

        "fields": [
          {
            "mode"     : "store",
            "name"     : "storage_account",
            "title"    : "Storage Account",
            "help"     : "Name of the Azure Storage Account for accessing the blobstore.",
            "type"     : "string",
            "required" : true
          }
        ]
      }
    }
  },
  "problems": [
    "This SHIELD agent is reporting ..."
  ]
}
</code></pre>

<p>The top-level <code>agents</code> key contains the same agent
information that the <code>GET /v2/agents</code> endpoint
returns.  Similarly, the <code>problems</code> key contains the
list of issues the SHIELD Core detected, based on this
agent's configuration / version.</p>

<p>The <code>metadata</code> key is exclusive to this endpoint, and
contains all of the agent metadata.  Of particular
interest is the <code>plugins</code> key, which contains a map of
plugin metadata, keyed by the plugin name.  The format
of this metadata is documented in
<a href="/docs/plugins.md">/docs/plugins.md</a>.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>admin</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve agent information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such agent</strong>:
The requested agent UUID was not found in the list
of registered agents.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/agents/:uuid/show</h3>

<p>Mark a single SHIELD agent as visible to all tenants, and
available for configuration.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X POST https://shield.host/v2/agents/:uuid/show \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok" : "Agent is now visible to everyone"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>admin</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve agent information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to set agent visibility</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such agent</strong>:
The requested agent UUID was not found in the list
of registered agents.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/agents/:uuid/hide</h3>

<p>Hide a single SHIELD agent from all tenants, rendering it unusable
in storage and target configuration.  Pre-existing configurations
will continue to function; this only affects visibility for future
configuration.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X POST https://shield.host/v2/agents/:uuid/hide \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok" : "Agent is now visible to everyone"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>admin</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve agent information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to set agent visibility</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such agent</strong>:
The requested agent UUID was not found in the list
of registered agents.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/agents/:uuid/resync</h3>

<p>Re-synchronize a SHIELD agent by immediately contacting it via the
agent channel and interrogating it for status and metadata.  This
allows administrators to force a re-check of an agent, regardless of
slow loop scheduling.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X POST https://shield.host/v2/agents/:uuid/resync \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok" : "Ad hoc agent resynchronization underway"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>admin</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve agent information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such agent</strong>:
The requested agent UUID was not found in the list
of registered agents.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/tenants/:tenant/agents</h3>

<p>Retrieves information about all registered SHIELD Agents,
viewable by a given tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/agents
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "agents": [
    {
      "name"         : "prod/web/42",
      "uuid"         : "1869e296-4aac-4a17-848d-04f73f743326",
      "address"      : "127.0.0.1:5444",
      "version"      : "dev",
      "status"       : "ok",
      "hidden"       : false,
      "last_error"   : "",
      "last_seen_at" : "2017-10-11 18:54:00"
    }
  ]
}
</code></pre>

<p>The top-level <code>agents</code> key is a list of object describing each registered agent:</p>

<ul>
<li><p><strong>name</strong> - The name of the SHIELD Agent, as set by
the local system administrator (which may not be the
SHIELD site administrator).</p></li>
<li><p><strong>uuid</strong> - The internal UUID assigned to this agent by the SHIELD Core.</p></li>
<li><p><strong>address</strong> - The <code>host:port</code> of the agent, from the
point-of-view of the SHIELD Core.</p></li>
<li><p>**version - The version of the remote SHIELD Agent's software.</p></li>
<li><p>**status - The health status of the remote SHIELD
Agent, one of <code>ok</code> or <code>failing</code>.</p></li>
<li><p>**hidden - Whether or not this agent has been administratively hidden.</p></li>
<li><p>**last_error - TBD</p></li>
<li><p>**last_seen_at - When the remote SHIELD Agent last
made contact with the SHIELD Core to refresh its
registration and its metadata.  Date is formatted
YYYY-MM-DD HH:MM:SS, in 24-hour notation.</p></li>
</ul>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve agent information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/tenants/:tenant/agents/:uuid</h3>

<p>Retrieve extended information about a single SHIELD Agent,
viewable by a given tenant.  This includes plugin metadata, but
not problem information (which is accessible via <code>GET /v2/agents</code>,
but only to SHIELD administrators).</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/agents/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "agent": {
    "name"         : "prod/web/42",
    "uuid"         : "1869e296-4aac-4a17-848d-04f73f743326",
    "address"      : "127.0.0.1:5444",
    "version"      : "dev",
    "status"       : "ok",
    "hidden"       : false,
    "last_error"   : "",
    "last_seen_at" : "2017-10-11 18:54:00"
  },
  "metadata": {
    "name"    : "prod/web/42",
    "version" : "dev",
    "health"  : "ok",

    "plugins": {
      "fs": {
        "author"   : "shieldproject",
        "features" : {
          "store"  : "yes",
          "target" : "no"
        },

        "fields": [
          {
            "mode"     : "store",
            "name"     : "storage_account",
            "title"    : "Storage Account",
            "help"     : "Name of the Azure Storage Account for accessing the blobstore.",
            "type"     : "string",
            "required" : true
          }
        ]
      }
    }
  }
}
</code></pre>

<p>The top-level <code>agents</code> key contains the same agent
information that the <code>GET /v2/tenants/:tenant/agents</code> endpoint
returns.</p>

<p>The <code>metadata</code> key is exclusive to this endpoint, and
contains all of the agent metadata.  Of particular
interest is the <code>plugins</code> key, which contains a map of
plugin metadata, keyed by the plugin name.  The format
of this metadata is documented in
<a href="/docs/plugins.md">/docs/plugins.md</a>.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve agent information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such agent</strong>:
The requested agent UUID was not found in the list
of registered agents visible to this tenant.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h2>SHIELD Tenants</h2>

<p>Tenants serve to insulate groups of SHIELD users from one another,
providing them a virtual view of SHIELD resources.  Each tenant
has their own targets, stores, and retention policy definitions,
as well as their own job configurations.  Each tenants archives
and tasks are visible only to members of that tenant, pursuant to
their assigned roles.</p>

<h3>GET /v2/tenants</h3>

<p>Retrieve the list of all tenants currently defined.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants
</code></pre>

<ul>
<li><p><strong>?exact=(t|f)</strong>
When filtering tenants, perform either exact field / value
matching (<code>exact=t</code>), or fuzzy search (<code>exact=f</code>, the
default)</p></li>
<li><p><strong>?uuid=</strong>
Only show the tenant that matches the given UUID.
This is a FIXME - we probably need to remove this.</p></li>
<li><p><strong>?name=...</strong>
Only show tenant whose name matches the given value.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?limit=N</strong>
Limit the returned result set to the first <em>limit</em> users
that match the other filtering rules.  A limit of <code>0</code> (the
default) denotes an unlimited search.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid": "f2ebbb9f-87f9-43e0-8515-dfce5d4d844c",
    "name": "A Tenant",

    "archive_count"  : 32,
    "storage_used"   : 140509184,
    "daily_increase" : 1520435
  },
  {
    "uuid": "4b6f6e2a-6ac6-443e-a910-aa412744165e",
    "name": "Some Other Tenant",

    "archive_count"  : 2,
    "storage_used"   : 268435456,
    "daily_increase" : 268435456
  }
]
</code></pre>

<p>For each tenant, SHIELD will also return a handful of tenant
metrics, including how many backup archives belong to the tenant
(<code>archive_count</code>), the total amount of cloud storage used, in
bytes (<code>storage_used</code>), and a linear-fit daily delta of storage
usage (<code>daily_increase</code>), also in bytes.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve tenants information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants</h3>

<p>Create a new tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/tenants \
     --data-binary '
{
  "name"  : "New Tenant Name",
  "users" : [
    {
      "uuid"    : "989b724b-bd3d-4799-bfbd-75b2fb5b41f3",
      "account" : "juser",
      "role"    : "engineer"
    },
    {
      "uuid"    : "96d24e33-8e57-4431-95fb-f18b9dfa319a",
      "account" : "jhunt",
      "role"    : "operator"
    }
  ]
}'
</code></pre>

<p>The <code>name</code> field is required.</p>

<p>The <code>users</code> list contains a list of initial tenant
role assignments.  The <code>account</code> key of each user
object is optional, but can assist site administrators
when troubleshooting assignment issues (since it will
be printed to the log) -- integrations are encouraged
to always send it.</p>

<p>The <code>role</code> field indicates what level of access to
grant each invitee, and must be one of:</p>

<ul>
<li><p><strong>admin</strong> - Full administrative control, including the ability to add
and remove users from the tenant, and change role assignments.  Use with
caution.</p></li>
<li><p><strong>engineer</strong> - Full configuration control, including the ability to
create, update, and delete targets, stores, and retention policies.</p></li>
<li><p><strong>operator</strong> - Operational access for running ad hoc backup jobs,
pausing and unpausing defined jobs, and performing restores.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>{
  "name": "A New Tenant",
  "uuid": "52d20ef4-f154-431e-a5bb-bb3a200976bb",

  "archive_count"  : 0,
  "storage_used"   : 0,
  "daily_increase" : 0
}
</code></pre>

<p><strong>NOTE</strong>: You cannot (for obvious reasons) set the
<code>archive_count</code>, <code>storage_used</code> and <code>daily_increase</code> fields when
you create a tenant.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Tenant name 'system' is reserved</strong>:
You attempted to create a tenant named system
(case-insensitive), which is not allowed.  SHIELD uses the
tenant name "SYSTEM" for its own, internal purposes.</p></li>
<li><p><strong>Unable to creeate new tenant</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><em>*Unable to install template retention policies into new tenant
*</em>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unrecognized user account</strong>:
The request indicated a tenant invitation to a user
account that was not found in the SHIELD database.
The request should not be retried.</p></li>
<li><p><em>*Unable to invite $user to tenant $tenant - only
local users can be invited.
*</em>:
The request indicated a tenant invitation to a user
account that was created by a non-local
authentication provider (i.e. Github).  Tenant
assignments for 3rd party accounts are governed
solely by their corresponding authentication
provider configuration.  The request should not be
retried.</p></li>
<li><p><strong>Unable to invite $user to tenant $tenant</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/tenants/:uuid</h3>

<p>Request more detailed information about a single tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "name": "A Tenant",
  "uuid": "f2ebbb9f-87f9-43e0-8515-dfce5d4d844c",

  "archive_count"  : 32,
  "storage_used"   : 140509184,
  "daily_increase" : 1520435,

  "members": [
    {
      "uuid"    : "5cb299bf-217f-4756-8eaa-e8a47865869e",
      "account" : "jhunt",
      "name"    : "James Hunt",
      "backend" : "local",
      "role"    : "admin",
      "sysrole" : ""
    }
  ]
}
</code></pre>

<p>The <code>members</code> key will be absent if this tenant has no members.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve tenant information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to retrieve tenant memberships information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such tenant</strong>:
The requested tenant UUID was not found in the database.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>PATCH /v2/tenants/:uuid</h3>

<p>Update a tenant with new attributes.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X PATCH https://shield.host/v2/tenants/:uuid \
     --data-binary '
{
  "name" : "A New Name"
}'
</code></pre>

<p><strong>NOTE</strong>: You cannot (for obvious reasons) set the
<code>archive_count</code>, <code>storage_used</code> and <code>daily_increase</code> fields when
you update a tenant.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "name" : "A New Name",
  "uuid" : "adcfee48-8b43-4ba3-9438-e0da55b8e9df",

  "archive_count"  : 32,
  "storage_used"   : 140509184,
  "daily_increase" : 1520435
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to update tenant</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to retrieve tenant information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such tenant</strong>:
The requested tenant UUID was not found in the database.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants/:uuid/invite</h3>

<p>Invite one or more local users to a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/tenants/:uuid/invite \
     --data-binary '
{
  "users": [
    {
      "uuid"    : "5cb299bf-217f-4756-8eaa-e8a47865869e",
      "account" : "jhunt",
      "role"    : "operator"
    },
    {
      "uuid"    : "c608cc65-b134-4581-9bdc-1fa3d0367961",
      "account" : "tmitchell",
      "role"    : "engineer"
    }
  ]
}'
</code></pre>

<p>Even if you only need to invite a single user, you must specify a list of
user objects.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok" : "Invitations sent"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve tenant information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to update tenant memberships information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unrecognized user account</strong>:
The request indicated a tenant invitation to a user
account that was not found in the SHIELD database.
The request should not be retried.</p></li>
<li><p><em>*Unable to invite $user to tenant $tenant - only
local users can be invited
*</em>:
The request indicated a tenant invitation to a user
account that was created by a non-local
authentication provider (i.e. Github).  Tenant
assignments for 3rd party accounts are governed
solely by their corresponding authentication
provider configuration.  The request should not be
retried.</p></li>
<li><p><strong>Unable to invite $user to tenant $tenant</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such tenant</strong>:
The requested tenant UUID was not found in the database.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants/:uuid/banish</h3>

<p>Remove a user from a tenant they currently belong to.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/tenants/:uuid/banish \
     --data-binary '
{
  "users": [
    {
      "uuid"    : "20d5bd91-9f7b-4551-9279-8571b8292003",
      "account" : "gfranks"
    },
    {
      "uuid"    : "c608cc65-b134-4581-9bdc-1fa3d0367961",
      "account" : "tmitchell"
    }
  ]
}'
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok" : "Banishments served."
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve tenant information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to update tenant memberships information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unrecognized user account</strong>:
The request indicated a tenant banishment of a user
account that was not found in the SHIELD database.
The request should not be retried.</p></li>
<li><p><em>*Unable to banish $user to tenant $tenant - only
local users can be banished
*</em>:
The request indicated a tenant banishment of a user
account that was created by a non-local
authentication provider (i.e. Github).  Tenant
assignments for 3rd party accounts are governed
solely by their corresponding authentication
provider configuration.  The request should not be
retried.</p></li>
<li><p><strong>Unable to banish $user to tenant $tenant</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such tenant</strong>:
The requested tenant UUID was not found in the database.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/tenants/:uuid</h3>

<p>Remove a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/tenants/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Successfully deleted tenant"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>manager</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve tenant information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to delete tenant</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such tenant</strong>:
The requested tenant UUID was not found in the database.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h2>SHIELD Targets</h2>

<p>Targets represent the data systems that SHIELD runs backup and
restore operations against as course of normal function.</p>

<h3>GET /v2/tenants/:tenant/targets</h3>

<p>Retrieve all defined targets for a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/targets
</code></pre>

<ul>
<li><p><strong>?exact=(t|f)</strong>
When filtering targets, perform either exact field / value
matching (<code>exact=t</code>), or fuzzy search (<code>exact=f</code>, the
default)</p></li>
<li><p><strong>?unused=(t|f)</strong>
When filtering targets, skip those that are unused (true) or used (false)</p></li>
<li><p><strong>?name=...</strong>
Only show targets whose name matches the given value.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?plugin=...</strong>
Only show targets who are associated with the given plugin.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?limit=N</strong>
Limit the returned result set to the first <em>limit</em> users
that match the other filtering rules.  A limit of <code>0</code> (the
default) denotes an unlimited search.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid"     : "b4400ee0-dce9-4277-9948-02a56ad51b17",
    "name"     : "Some Target",
    "summary"  : "The operator-supplied description of this target",
    "agent"    : "127.0.0.1:5444",
    "plugin"   : "fs",

    "config" : {
      "target"   : "specific",
      "settings" : "and configuration"
    }
  }
]
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve targets information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants/:tenant/targets</h3>

<p>Create a new target in a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/tenants/:tenant/targets \
     --data-binary '
{
  "name"     : "New Target Name",
  "summary"  : "A longer description of the target",
  "agent"    : "127.0.0.1:5444",
  "endpoint" : "{}",
  "plugin"   : "plugin"
}'
</code></pre>

<p>Note: the <code>endpoint</code> key is currently a string of JSON, which
means that it contains lots of escape sequences.  Future versions
of the v2 API (prior to launch) may alter this to be the full
JSON, inline, for both readability and sanity's sake.</p>

<p>FIXME: Fix target.endpoint string -> JSON problem.</p>

<p>The following query string parameters are honored:</p>

<ul>
<li><strong>?test=(t|f)</strong>
Perform all validation and preparatory steps, but don't
actually create the target in the database.  This is useful
for validating that a target <em>could</em> be created, without
creating it (i.e. for defering creation until later).</li>
</ul>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"     : "b6d03df5-6978-43d8-ad9e-a22f8ec8457a",
  "name"     : "New Target Name",
  "summary"  : "A longer description of the target",
  "agent"    : "127.0.0.1:5444",
  "endpoint" : "{}",
  "plugin"   : "plugin"
}
</code></pre>

<p>Note: the <code>endpoint</code> key is currently a string of JSON, which
means that it contains lots of escape sequences.  Future versions
of the v2 API (prior to launch) may alter this to be the full
JSON, inline, for both readability and sanity's sake.</p>

<p>FIXME: Fix target.endpoint string -> JSON problem.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated
session or auth token.  See <strong>Authentication</strong> for
more details.  The request may be retried after
authentication.</p></li>
<li><p><strong>Unable to retrieve tenant information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such tenant</strong>:
No tenant was found with the given UUID.</p></li>
<li><p><strong>Unable to create new data target</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/tenants/:tenant/targets/:uuid</h3>

<p>Retrieve a single target for a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/targets/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"     : "b4400ee0-dce9-4277-9948-02a56ad51b17",
  "name"     : "Some Target",
  "summary"  : "The operator-supplied description of this target",
  "agent"    : "127.0.0.1:5444",
  "endpoint" : "{}",
  "plugin"   : "fs"
}
</code></pre>

<p>Note: the <code>endpoint</code> key is currently a string of JSON, which
means that it contains lots of escape sequences.  Future versions
of the v2 API (prior to launch) may alter this to be the full
JSON, inline, for both readability and sanity's sake.</p>

<p>FIXME: Fix target.endpoint string -> JSON problem.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve tenant information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such target</strong>:
No target with the given UUID exists on the
specified tenant.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>PUT /v2/tenants/:tenant/targets/:uuid</h3>

<p>Update an existing target on a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X PUT https://shield.host/v2/tenants/:tenant/targets/:uuid \
     --data-binary '
{
  "name"     : "Updated Target Name",
  "summary"  : "A longer description of the target",
  "agent"    : "127.0.0.1:5444",
  "endpoint" : "{}",
  "plugin"   : "plugin"
}'
</code></pre>

<p>You can specify as many or few of these fields as you want;
omitted fields will be left at their previous values.</p>

<p>Note: the <code>endpoint</code> key is currently a string of JSON, which
means that it contains lots of escape sequences.  Future versions
of the v2 API (prior to launch) may alter this to be the full
JSON, inline, for both readability and sanity's sake.</p>

<p>FIXME: Fix target.endpoint string -> JSON problem.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok" : "Updated target successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve tenant information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such target</strong>:
No target with the given UUID exists on the
specified tenant.</p></li>
<li><p><strong>Unable to update target</strong>:
No target with the given UUID exists on the
specified tenant.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/tenants/:tenant/targets/:uuid</h3>

<p>Remove a target from a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/tenants/:tenant/targets/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Target deleted successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve tenant information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such target</strong>:
No target with the given UUID exists on the
specified tenant.</p></li>
<li><p><strong>Unable to delete target</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>The target cannot be deleted at this time</strong>:
This target is referenced by one or more extant job
configuration; deleting it would lead to an
incomplete (and unusable) setup.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h2>SHIELD Stores</h2>

<p>Storage systems are essential to any data protection efforts,
since the protected data must reside elsewhere, on another system
in order to be truly safe.  Stores provide definitions of external
storage system where backup archives will be kept.</p>

<p><strong>NOTE:</strong> the API endpoints in this section deal exclusively with
tenant-scoped storage systems.  For information on the endpoints
for managing global storage solutions, see the section titled
<strong>SHIELD Global Resources</strong>.</p>

<h3>GET /v2/tenants/:tenant/stores</h3>

<p>Retrieve all defined stores for a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/stores
</code></pre>

<ul>
<li><p><strong>?exact=(t|f)</strong>
When filtering stores, perform either exact field / value
matching (<code>exact=t</code>), or fuzzy search (<code>exact=f</code>, the
default)</p></li>
<li><p><strong>?unused=(t|f)</strong>
When filtering stores, skip those that are unused (true) or used (false)</p></li>
<li><p><strong>?name=...</strong>
Only show stores whose name matches the given value.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?plugin=...</strong>
Only show stores who are associated with the given plugin.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?limit=N</strong>
Limit the returned result set to the first <em>limit</em> users
that match the other filtering rules.  A limit of <code>0</code> (the
default) denotes an unlimited search.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid"    : "925c83ad-22e6-4cdd-bf63-6dd6d09cd86f",
    "name"    : "Cloud Storage Name",
    "global"  : false,
    "summary" : "A longer description of the storage configuration",
    "agent"   : "127.0.0.1:5444",
    "plugin"  : "fs",
    "config"  : {
      "base_dir" : "/var/data/root",
      "bsdtar"   : "bsdtar"
    },
    "threshold": 1073741824
  }
]
</code></pre>

<p>The values under <code>config</code> will depend entirely on what the
operator specified when they initially configured the storage
system.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve storage systems information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants/:tenant/stores</h3>

<p>Create a new store on a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/tenants/:tenant/stores \
     --data-binary '
{
  "name"    : "Storage System Name",
  "summary" : "A longer description for this storage system.",
  "plugin"  : "plugin-name",
  "agent"   : "127.0.0.1:5444",
  "config"  : {
    "plugin-specific": "configuration"
  },
  "threshold": 1073741824
}'
</code></pre>

<p>The values under <code>config</code> will depend entirely on which <code>plugin</code>
has been selected; no validation will be done by the SHIELD Core,
until the storage system is used in a job.</p>

<p>The following query string parameters are honored:</p>

<ul>
<li><strong>?test=(t|f)</strong>
Perform all validation and preparatory steps, but don't
actually create the store in the database.  This is useful
for validating that a store <em>could</em> be created, without
creating it (i.e. for defering creation until later).</li>
</ul>

<p><strong>Response</strong></p>

<pre><code>{
  "name"    : "Storage System Name",
  "summary" : "A longer description for this storage system.",
  "plugin"  : "plugin-name",
  "agent"   : "127.0.0.1:5444",
  "config"  : {
    "plugin-specific": "configuration"
  },
  "threshold": 1073741824
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve storage system information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to create new storage system</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/tenants/:tenant/stores/:uuid</h3>

<p>Retrieve a single store for the given tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/stores/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"    : "925c83ad-22e6-4cdd-bf63-6dd6d09cd86f",
  "name"    : "Cloud Storage Name",
  "global"  : false,
  "summary" : "A longer description of the storage configuration",
  "plugin"  : "fs",
  "agent"   : "127.0.0.1:5444",
  "config"  : {
    "base_dir" : "/var/data/root",
    "bsdtar"   : "bsdtar"
  },
  "threshold": 1073741824
}
</code></pre>

<p>The values under <code>config</code> will depend entirely on what the
operator specified when they initially configured the storage
system.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve storage system information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such storage system</strong>:
No storage system with the given UUID exists on the
specified tenant.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>PUT /v2/tenants/:tenant/stores/:uuid</h3>

<p>Update an existing store on a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X PUT https://shield.host/v2/tenants/:tenant/stores/:uuid \
     --data-binary '
{
  "name"    : "Updated Store Name",
  "summary" : "A longer description of the storage system",
  "agent"   : "127.0.0.1:5444",
  "plugin"  : "plugin",
  "config"  : {
    "new": "plugin configuration"
  },
  "threshold": 1073741824
}'
</code></pre>

<p>You can specify as many or few of these fields as you want;
omitted fields will be left at their previous values.  If <code>config</code>
is supplied, it will overwrite the value currently in the
database.</p>

<p>The values under <code>config</code> will depend entirely on which <code>plugin</code>
has been selected; no validation will be done by the SHIELD Core,
until the storage system is used in a job.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "name"    : "Updated Store Name",
  "summary" : "A longer description of the storage system",
  "agent"   : "127.0.0.1:5444",
  "plugin"  : "plugin",
  "config"  : {
    "new": "plugin configuration"
  },
  "threshold": 1073741824
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve storage system information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to update storage system</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such storage system</strong>:
No storage system with the given UUID exists on the
specified tenant.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/tenants/:tenant/stores/:uuid</h3>

<p>Remove a store from a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/tenants/:tenant/stores/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Storage system deleted successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve storage system information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to delete storage system</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such storage system</strong>:
No storage system with the given UUID exists on the
specified tenant.</p></li>
<li><p><strong>The storage system cannot be deleted at this time</strong>:
This storage system is referenced by one or more
extant job configuration; deleting it would lead to
an incomplete (and unusable) setup.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h2>SHIELD Retention Policies</h2>

<p>Retention Policies govern how long backup archives are kept,
to ensure that storage usage doesn't continue to increase
inexorably.</p>

<h3>GET /v2/tenants/:tenant/policies</h3>

<p>Retrieve all defined retention policies for a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/policies
</code></pre>

<ul>
<li><p><strong>?exact=(t|f)</strong>
When filtering policies, perform either exact field / value
matching (<code>exact=t</code>), or fuzzy search (<code>exact=f</code>, the
default)</p></li>
<li><p><strong>?unused=(t|f)</strong>
When filtering policies, skip those that are unused (true) or used (false)</p></li>
<li><p><strong>?name=...</strong>
Only show policies whose name matches the given value.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?limit=N</strong>
Limit the returned result set to the first <em>limit</em> users
that match the other filtering rules.  A limit of <code>0</code> (the
default) denotes an unlimited search.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid"    : "f4dedf80-cdb2-4c81-9a58-b3a8282e3202",
    "name"    : "Long-Term Storage",
    "summary" : "A long-term solution, for infrequent backups only.",
    "expires" : 7776000
  }
]
</code></pre>

<p>The <code>expires</code> key is specified in seconds, but must
always be a multiple of 86400 (1 day).</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve retention policies information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants/:tenant/policies</h3>

<p>Create a new retention policy in a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/tenants/:tenant/policies \
     --data-binary '
{
  "name"    : "Retention Policy Name",
  "summary" : "A longer description of the policy",
  "expires" : 86400
}'
</code></pre>

<p>The <code>expires</code> value must be specified in seconds, and
must be at least 86,400 (1 day) and be a multiple of
86,400.</p>

<p>The following query string parameters are honored:</p>

<ul>
<li><strong>?test=(t|f)</strong>
Perform all validation and preparatory steps, but don't
actually create the policy in the database.  This is useful
for validating that a policy <em>could</em> be created, without
creating it (i.e. for defering creation until later).</li>
</ul>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"    : "4882b332-6182-4123-984f-f9e5dd8dae20",
  "name"    : "Retention Policy Name",
  "summary" : "A longer description of the policy",
  "expires" : 86400
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Retention policy expiry must be greater than 1 day</strong>:
You supplied an <code>expires</code> value less than 86,400.
Please re-try the request with a higher value.</p></li>
<li><p><strong>Retention policy expire must be a multiple of 1 day</strong>:
You supplied an <code>expires</code> value that was not a
multiple of 86,400.  Please re-try the request with
a different value.</p></li>
<li><p><strong>Unable to create retention policy</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/tenants/:tenant/policies/:uuid</h3>

<p>Retrieve a single retention policy for a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/policies/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"    : "4882b332-6182-4123-984f-f9e5dd8dae20",
  "name"    : "Retention Policy Name",
  "summary" : "A longer description of the policy",
  "expires" : 86400
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve retention policy information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such retention policy</strong>:
No retention policy with the given UUID exists on
the specified tenant.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>PUT /v2/tenants/:tenant/policies/:uuid</h3>

<p>Update a single retention policy on a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X PUT https://shield.host/v2/tenants/:tenant/policies/:uuid \
     --data-binary '
{
  "name"    : "Updated Retention Policy Name",
  "summary" : "A longer description of the retention policy",
  "expires" : 86400
}'
</code></pre>

<p>You can specify as many or few of these fields as you want;
omitted fields will be left at their previous values.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"    : "4882b332-6182-4123-984f-f9e5dd8dae20",
  "name"    : "Retention Policy Name",
  "summary" : "A longer description of the policy",
  "expires" : 86400
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Retention policy expiry must be greater than 1 day</strong>:
You supplied an <code>expires</code> value less than 86,400.
Please re-try the request with a higher value.</p></li>
<li><p><strong>Retention policy expire must be a multiple of 1 day</strong>:
You supplied an <code>expires</code> value that was not a
multiple of 86,400.  Please re-try the request with
a different value.</p></li>
<li><p><strong>Unable to retrieve retention policy template information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to update retention policy</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such retention policy</strong>:
No retention policy with the given UUID exists on
the specified tenant.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/tenants/:tenant/policies/:uuid</h3>

<p>Remove a retention policy from a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/tenants/:tenant/policies/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Retention policy deleted successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve retention policy information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such retention policy</strong>:
No retention policy with the given UUID exists on
the specified tenant.</p></li>
<li><p><strong>Unable to delete retention policy</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>The retention policy cannot be deleted at this time</strong>:
This retention policy is referenced by one or more
extant job configuration; deleting it would lead to
an incomplete (and unusable) setup.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h2>SHIELD Jobs</h2>

<p>Jobs are discrete, schedulable backup operations that tie together a
target system, a cloud storage system, a schedule, and a retention
policies.  Without Jobs, SHIELD cannot actually back anything up.</p>

<h3>GET /v2/tenants/:tenant/jobs</h3>

<p>Retrieve all defined jobs for a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/jobs?name=redis&amp;paused=t
</code></pre>

<p>By default, all jobs for the tenant will be returned.  You can
filter down to a subset of that by the following query string
parameters:</p>

<ul>
<li><p><strong>?exact=(t|f)</strong>
When filtering jobs, perform either exact field / value
matching (<code>exact=t</code>), or fuzzy search (<code>exact=f</code>, the
default)</p></li>
<li><p><strong>?paused=(t|f)</strong>
Show only paused (<code>paused=t</code>) or unpaused (<code>paused=f</code>) jobs.
If omitted, all jobs are shown, regardless of their
pausedness.</p></li>
<li><p><strong>?name=...</strong>
Show only jobs whose names match the given value.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?target=...</strong>
Show only jobs whose target UUIDs match the given value.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?store=...</strong>
Show only jobs whose store UUIDs match the given value.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?policy=...</strong>
Show only jobs whose retention policy UUIDs match the given
value.  Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"        : "30f34d8f-762e-402a-b7ce-769a4a68de90",
  "name"        : "Job Name",
  "summary"     : "A longer description",
  "compression" : "bzip2",
  "expiry"      : 604800,
  "schedule"    : "daily 4am",
  "paused"      : false,
  "agent"       : "10.0.0.5:5444",
  "last_run"    : "2017-10-19 03:00:00",
  "status"      : "done",

  "policy" : {
    "uuid"    : "9a112894-10eb-439f-afd5-01597d8faf64",
    "name"    : "Retention Policy Name",
    "summary" : "A longer description"
  },

  "store" : {
    "uuid"    : "5945ef33-2cb6-4d7e-a9b7-43cce1773457",
    "name"    : "Cloud Storage System Name",
    "summary" : "A longer description",
    "plugin"  : "s3",
    "config"  : {
      "storage" : "configuration"
    }
  },

  "target" : {
    "uuid"   : "9f602367-256a-4454-be56-9ddde1257f13",
    "name"   : "Data System Name",
    "plugin" : "fs",
    "config" : {
      "target" : "configuration"
    }
  }
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve tenant job information.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants/:tenant/jobs</h3>

<p>Configure a new backup job on a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/tenants/:tenant/jobs \
     --data-binary '
{
  "name"        : "New Job Name",
  "summary"     : "A longer description...",
  "schedule"    : "daily 4am",
  "compression" : "bzip2",
  "paused"      : false,

  "store"       : "af1ad037-c8c1-4036-984a-3cf726b4081d",
  "target"      : "2c64d9ff-fc9f-4114-8e89-9f7c84fcaac7",
  "policy"      : "cb6b0503-4741-4cfd-9a1d-11b5a5aaadde"
}'
</code></pre>

<p><strong>NOTE</strong>: As of right now, the <code>store</code>, <code>target</code>, and <code>policy</code>
values must be passed as the UUIDs of the related objects.</p>

<p>FIXME : allow non-UUIDs for all three.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"        : "30f34d8f-762e-402a-b7ce-769a4a68de90",
  "name"        : "Job Name",
  "summary"     : "A longer description",
  "compression" : "bzip2",
  "expiry"      : 604800,
  "schedule"    : "daily 4am",
  "paused"      : false,
  "agent"       : "10.0.0.5:5444",

  "last_run"         : "2017-10-19 03:00:00",
  "last_task_status" : "",

  "policy" : {
    "uuid"    : "9a112894-10eb-439f-afd5-01597d8faf64",
    "name"    : "Retention Policy Name",
    "summary" : "A longer description"
  },

  "store" : {
    "uuid"    : "5945ef33-2cb6-4d7e-a9b7-43cce1773457",
    "name"    : "Cloud Storage System Name",
    "summary" : "A longer description",
    "plugin"  : "s3",
    "config"  : {
      "storage" : "configuration"
    }
  },

  "target" : {
    "uuid"   : "9f602367-256a-4454-be56-9ddde1257f13",
    "name"   : "Data System Name",
    "plugin" : "fs",
    "config" : {
      "target" : "configuration"
    }
  }
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to create new job</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/tenants/:tenant/jobs/:uuid</h3>

<p>Retrieve a single job for a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/jobs/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"        : "30f34d8f-762e-402a-b7ce-769a4a68de90",
  "name"        : "Job Name",
  "summary"     : "A longer description",
  "compression" : "bzip2",
  "expiry"      : 604800,
  "schedule"    : "daily 4am",
  "paused"      : false,
  "agent"       : "10.0.0.5:5444",

  "last_run"         : "2017-10-19 03:00:00",
  "last_task_status" : "",

  "policy" : {
    "uuid"    : "9a112894-10eb-439f-afd5-01597d8faf64",
    "name"    : "Retention Policy Name",
    "summary" : "A longer description"
  },

  "store" : {
    "uuid"    : "5945ef33-2cb6-4d7e-a9b7-43cce1773457",
    "name"    : "Cloud Storage System Name",
    "summary" : "A longer description",
    "plugin"  : "s3",
    "config"  : {
      "storage" : "configuration"
    }
  },

  "target" : {
    "uuid"   : "9f602367-256a-4454-be56-9ddde1257f13",
    "name"   : "Data System Name",
    "plugin" : "fs",
    "config" : {
      "target" : "configuration"
    }
  }
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve tenant job information.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such job</strong>:
The requested job was not found in the database, or
it was not associated with the given tenant.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>PUT /v2/tenants/:tenant/jobs/:uuid</h3>

<p>Update a single job on a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X PUT https://shield.host/v2/tenants/:tenant/jobs/:uuid \
     --data-binary '
{
  "name"        : "New Name",
  "summary"     : "An updated summary",
  "compression" : "bzip2",
  "schedule"    : "daily 4am",

  "store"  : "a6ef5aea-51f6-4e91-a490-3063395f879b",
  "target" : "af1425ed-53fd-4ab6-a425-fb230c383901",
  "policy" : "c16a4783-19b8-400d-8b51-f47dcdc11da3"
}'
</code></pre>

<p>Any of the fields in the request payload can be omitted to keep
the pre-existing value.</p>

<p><strong>NOTE</strong>: As of right now, the <code>store</code>, <code>target</code>, and <code>policy</code>
values must be passed as the UUIDs of the related objects.</p>

<p>FIXME : allow non-UUIDs for all three.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Updated job successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve job information.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such job</strong>:
The requested job was not found in the database, or
it was not associated with the given tenant.</p></li>
<li><p><strong>Unable to update job.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/tenants/:tenant/jobs/:uuid</h3>

<p>Remove a job from a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/tenants/:tenant/jobs/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Job deleted successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve job information.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such job</strong>:
The requested job was not found in the database, or
it was not associated with the given tenant.</p></li>
<li><p><strong>Unable to delete job.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>The job could not be deleted at this time.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants/:tenant/jobs/:uuid/run</h3>

<p>Perform an ad hoc backup job run</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X POST https://shield.host/v2/tenants/:tenant/jobs/:uuid/run \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Scheduled ad hoc backup job run",
  "task_uuid": "6d38e8bd-42e9-4c23-bbb6-9a480e0e2a82"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve job information.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such job</strong>:
The requested job was not found in the database, or
it was not associated with the given tenant.</p></li>
<li><p><strong>Unable to schedule ad hoc backup job run.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants/:tenant/jobs/:uuid/pause</h3>

<p>Pause a job, to prevent it from being scheduled.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X POST https://shield.host/v2/tenants/:tenant/jobs/:uuid/pause \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Paused job successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve job information.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such job</strong>:
The requested job was not found in the database, or
it was not associated with the given tenant.</p></li>
<li><p><strong>Unable to pause job.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants/:tenant/jobs/:uuid/unpause</h3>

<p>Unpause a job, allowing it to be scheduled again.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X POST https://shield.host/v2/tenants/:tenant/jobs/:uuid/unpause \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Unpaused job successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve job information.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such job</strong>:
The requested job was not found in the database, or
it was not associated with the given tenant.</p></li>
<li><p><strong>Unable to unpause job.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h2>SHIELD Tasks</h2>

<p>Tasks represent the context, status, and output of the execution of
some operation, be it a scheduled backup job being run, an ad hoc
restore operation, etc.</p>

<p>Since tasks represent internal state, they cannot easily be created or
updated via operators.  Instead, the execution of the job, or the
triggering of some other action, will cause a task to spring into
existence and move through its lifecycle.</p>

<h3>GET /v2/tenants/:tenant/tasks</h3>

<p>Retrieve all tasks for a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/tasks
</code></pre>

<ul>
<li><p><strong>?active=(t|f)</strong>
When filtering tasks, show those that are active (true) or inactive (false)</p></li>
<li><p><strong>?status=...</strong>
Only show tasks whose status matches the given value.</p></li>
<li><p><strong>?target=</strong>
Only show tasks associated with a given target...</p></li>
<li><p><strong>?limit=N</strong>
Limit the returned result set to the first <em>limit</em> users
that match the other filtering rules.  A limit of <code>0</code> (the
default) denotes an unlimited search.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid"         : "df2fd352-83b8-45b8-8f7b-ef74cf9eafdc",
    "owner"        : "user@backend",
    "type"         : "backup",
    "job_uuid"     : "bd2c5ac0-b499-4085-857e-69fa38441419",
    "archive_uuid" : "eb096379-7c45-4679-9b47-c563276dc22e",
    "status"       : "running",
    "started_at"   : "2017-10-17 04:51:16",
    "stopped_at"   : "",
    "log"          : "running log...",
    "notes"        : "Annotated notes about this task",
    "clear"        : "manual"
  }
]
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve task information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Invalid limit parameter given</strong>:
Request specified a <code>limit</code> parameter that was either
non-numeric, or was negative.  Note that <code>0</code> is a valid limit,
standing for <em>unlimited</em>.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/tenants/:tenant/tasks/:uuid</h3>

<p>Retrieve a single task.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/tasks/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"         : "df2fd352-83b8-45b8-8f7b-ef74cf9eafdc",
  "owner"        : "user@backend",
  "type"         : "backup",
  "job_uuid"     : "bd2c5ac0-b499-4085-857e-69fa38441419",
  "archive_uuid" : "eb096379-7c45-4679-9b47-c563276dc22e",
  "status"       : "running",
  "started_at"   : "2017-10-17 04:51:16",
  "stopped_at"   : "",
  "log"          : "running log...",
  "notes"        : "Annotated notes about this task",
  "clear"        : "manual"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve task information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such task</strong>:
You requested details on a task that either doesn't exist, or
is not tied to the given tenant.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/tenants/:tenant/tasks/:uuid</h3>

<p>Cancel a task.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/tenants/:tenant/tasks/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Task canceled successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve task information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such task</strong>:
You requested details on a task that either doesn't exist, or
is not tied to the given tenant.</p></li>
<li><p><strong>Unable to cancel task</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h2>SHIELD Backup Archives</h2>

<p>Each backup archive contains the complete set of data retrieved from a
target system during a single backup job task.</p>

<p>Archives cannot be created <em>a priori</em> via the API alone.  New archives
will be created from scheduled and ad hoc backup jobs, when they
succeed.</p>

<h3>GET /v2/tenants/:tenant/archives</h3>

<p>Retrieve all archives for a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/archives
</code></pre>

<ul>
<li><p><strong>?target=</strong>
Only show the archives that beloing to the the given target UUID.</p></li>
<li><p><strong>?store=</strong>
Only show the archives that beloing to the the given store UUID.</p></li>
<li><p><strong>?before=</strong>
Only show the archives created before the given time.</p></li>
<li><p><strong>?after=</strong>
Only show the archives created after the given time.</p></li>
<li><p><strong>?status=...</strong>
Only show the archives with the given status.</p></li>
<li><p><strong>?limit=N</strong>
Limit the returned result set to the first <em>limit</em> users
that match the other filtering rules.  A limit of <code>0</code> (the
default) denotes an unlimited search.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid"         : "5c8cef06-190c-4b07-a0b7-8452f6faff26",
    "key"          : "2017/10/27/2017-10-27-120512-948428f4-3a83-4b5d-8a41-7d27ca81ce8d",
    "taken_at"     : "2017-10-27 16:05:25",
    "expires_at"   : "2017-10-28 16:05:25",
    "notes"        : "",
    "compression"  : "bzip2",
    "encryption_type" : "aes256-ctr",
    "size"         : 43306681,
    "status"       : "valid",
    "purge_reason" : "",
    "job"          : "Hourly",

    "tenant_uuid" : "5524167e-cf56-4a8f-9580-cfca40949316",

    "target_uuid"     : "51d9cced-b11d-4b76-b9f3-fe0be4cd6087",
    "target_name"     : "SHIELD",
    "target_plugin"   : "fs",
    "target_endpoint" : "{\"base_dir\":\"/e/no/ent\",\"bsdtar\":\"bsdtar\",\"exclude\":\"var/*.db\"}",

    "store_uuid"     : "828fccae-a11e-41ee-bc13-d33c4dff1241",
    "store_name"     : "CloudStor",
    "store_plugin"   : "fs",
    "store_endpoint" : "{\"base_dir\":\"/tmp/shield.testdev.storeNy0fewQ\",\"bsdtar\":\"bsdtar\"}"
  }
]
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve backup archives information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Invalid limit parameter given</strong>:
Request specified a <code>limit</code> parameter that was either
non-numeric, or was negative.  Note that <code>0</code> is a valid limit,
standing for <em>unlimited</em>.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/tenants/:tenant/archives/:uuid</h3>

<p>Retrieve a single archive for a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/tenants/:tenant/archives/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"         : "5c8cef06-190c-4b07-a0b7-8452f6faff26",
  "key"          : "2017/10/27/2017-10-27-120512-948428f4-3a83-4b5d-8a41-7d27ca81ce8d",
  "taken_at"     : "2017-10-27 16:05:25",
  "expires_at"   : "2017-10-28 16:05:25",
  "notes"        : "",
  "compression"  : "bzip2",
  "encryption_type" : "aes256-ctr",
  "size"         : 43306681,
  "status"       : "valid",
  "purge_reason" : "",
  "job"          : "Hourly",

  "tenant_uuid" : "5524167e-cf56-4a8f-9580-cfca40949316",

  "target_uuid"     : "51d9cced-b11d-4b76-b9f3-fe0be4cd6087",
  "target_name"     : "SHIELD",
  "target_plugin"   : "fs",
  "target_endpoint" : "{\"base_dir\":\"/e/no/ent\",\"bsdtar\":\"bsdtar\",\"exclude\":\"var/*.db\"}",

  "store_uuid"     : "828fccae-a11e-41ee-bc13-d33c4dff1241",
  "store_name"     : "CloudStor",
  "store_plugin"   : "fs",
  "store_endpoint" : "{\"base_dir\":\"/tmp/shield.testdev.storeNy0fewQ\",\"bsdtar\":\"bsdtar\"}"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve backup archive information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Archive Not Found</strong>:
You requested details on an archive that either doesn't exist, or
is not tied to the given tenant.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>PUT /v2/tenants/:tenant/archives/:uuid</h3>

<p>Update a single archive on a tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X PUT https://shield.host/v2/tenants/:tenant/archives/:uuid \
     --data-binary '
{
  "notes": "Notes for this specific archive"
}'
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"         : "5c8cef06-190c-4b07-a0b7-8452f6faff26",
  "key"          : "2017/10/27/2017-10-27-120512-948428f4-3a83-4b5d-8a41-7d27ca81ce8d",
  "taken_at"     : "2017-10-27 16:05:25",
  "expires_at"   : "2017-10-28 16:05:25",
  "notes"        : "",
  "compression"  : "bzip2",
  "encryption_type" : "aes256-ctr",
  "size"         : 43306681,
  "status"       : "valid",
  "purge_reason" : "",
  "job"          : "Hourly",

  "tenant_uuid" : "5524167e-cf56-4a8f-9580-cfca40949316",

  "target_uuid"     : "51d9cced-b11d-4b76-b9f3-fe0be4cd6087",
  "target_name"     : "SHIELD",
  "target_plugin"   : "fs",
  "target_endpoint" : "{\"base_dir\":\"/e/no/ent\",\"bsdtar\":\"bsdtar\",\"exclude\":\"var/*.db\"}",

  "store_uuid"     : "828fccae-a11e-41ee-bc13-d33c4dff1241",
  "store_name"     : "CloudStor",
  "store_plugin"   : "fs",
  "store_endpoint" : "{\"base_dir\":\"/tmp/shield.testdev.storeNy0fewQ\",\"bsdtar\":\"bsdtar\"}"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve backup archive information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such backup archive</strong>:
You requested details on an archive that either doesn't exist, or
is not tied to the given tenant.</p></li>
<li><p><strong>Unable to update backup archive</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>POST /v2/tenants/:tenant/archives/:uuid/restore</h3>

<p>Restore a backup archive for a tenant, either to the original
target system it was taken from, or against a different target
owned by the same tenant.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/tenants/:tenant/archives/:uuid/restore \
     --data-binary '
{
  "target" : "2a1731c0-7d0e-4f31-8860-7d0ae7a34261"
}'
</code></pre>

<p>Here, <code>target</code> is an optional UUID of an alternative data system
to restore this archive to.  This target must exist inside the
same tenant.  By default, if <code>target</code> is omitted, the archive
will be restored back to the target it was created from.</p>

<p><strong>Response</strong></p>

<p>When a restore has been scheduled for execution, it generates a
task inside of SHIELD, which is then returned as the result to
the requester:</p>

<pre><code>{
  "uuid"         : "df2fd352-83b8-45b8-8f7b-ef74cf9eafdc",
  "owner"        : "user@backend",
  "type"         : "restore",
  "job_uuid"     : "bd2c5ac0-b499-4085-857e-69fa38441419",
  "archive_uuid" : "eb096379-7c45-4679-9b47-c563276dc22e",
  "status"       : "running",
  "started_at"   : "2017-10-17 04:51:16",
  "stopped_at"   : "",
  "log"          : "running log...",
  "notes"        : "Annotated notes about this task",
  "clear"        : "manual"
}
</code></pre>

<p>The <code>type</code> of this task will always be <code>restore</code>, and usually,
<code>log</code> will be empty and <code>stopped_at</code> will have no value, since
the task hasn't had time to run to completion.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve backup archive information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such backup archive</strong>:
The requested backup archive was not found in the database, or
it was not associated with the given tenant.</p></li>
<li><p><strong>Unable to schedule a restore task</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/tenants/:tenant/archives/:uuid</h3>

<p>Remove an archive from a tenant, and purge the archive
data from the backing storage system.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/tenants/:tenant/archives/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Archive deleted successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>operator</code> role on the tenant.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve backup archive information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such backup archive</strong>:
The requested backup archive was not found in the database, or
it was not associated with the given tenant.</p></li>
<li><p><strong>Unable to delete backup archive</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>The backup archive could not be deleted at this time.</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h2>SHIELD Global Resources</h2>

<p>Some resources are shared between tenants, either implicitly via
copying (like retention policies), or explicitly (like shared
storage system definitions).</p>

<h3>GET /v2/global/stores</h3>

<p>Retrieve all globally-defined stores.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/global/stores
</code></pre>

<ul>
<li><p><strong>?exact=(t|f)</strong>
When filtering stores, perform either exact field / value
matching (<code>exact=t</code>), or fuzzy search (<code>exact=f</code>, the
default)</p></li>
<li><p><strong>?unused=(t|f)</strong>
When filtering stores, skip those that are unused (true) or used (false)</p></li>
<li><p><strong>?name=...</strong>
Only show stores whose name matches the given value.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?plugin=...</strong>
Only show stores who are associated with the given plugin.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?limit=N</strong>
Limit the returned result set to the first <em>limit</em> users
that match the other filtering rules.  A limit of <code>0</code> (the
default) denotes an unlimited search.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid"    : "925c83ad-22e6-4cdd-bf63-6dd6d09cd86f",
    "name"    : "Cloud Storage Name",
    "global"  : true,
    "summary" : "A longer description of the storage configuration",
    "agent"   : "127.0.0.1:5444",
    "plugin"  : "fs",
    "config"  : {
      "base_dir" : "/var/data/root",
      "bsdtar"   : "bsdtar"
    }
  }
]
</code></pre>

<p>The values under <code>config</code> will depend entirely on what the
operator specified when they initially configured the storage
system.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve storage systems information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
</ul>

<h3>POST /v2/global/stores</h3>

<p>Create a new shared storage system.  This storage will be visible
to all tenants.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/global/stores \
     --data-binary '
{
  "name"    : "Storage System Name",
  "summary" : "A longer description for this storage system.",
  "plugin"  : "plugin-name",
  "agent"   : "127.0.0.1:5444",
  "config"  : {
    "plugin-specific": "configuration"
  }
}'
</code></pre>

<p>The values under <code>config</code> will depend entirely on which <code>plugin</code>
has been selected; no validation will be done by the SHIELD Core,
until the storage system is used in a job.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "name"    : "Storage System Name",
  "summary" : "A longer description for this storage system.",
  "plugin"  : "plugin-name",
  "agent"   : "127.0.0.1:5444",
  "config"  : {
    "plugin-specific": "configuration"
  }
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve storage system information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to create new storage system</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/global/stores/:uuid</h3>

<p>Retrieve a single globally-defined storage system.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/global/stores/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"    : "925c83ad-22e6-4cdd-bf63-6dd6d09cd86f",
  "name"    : "Cloud Storage Name",
  "global"  : true,
  "summary" : "A longer description of the storage configuration",
  "plugin"  : "fs",
  "agent"   : "127.0.0.1:5444",
  "config"  : {
    "base_dir" : "/var/data/root",
    "bsdtar"   : "bsdtar"
  }
}
</code></pre>

<p>The values under <code>config</code> will depend entirely on what the
operator specified when they initially configured the storage
system.</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve storage system information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such storage system</strong>:
No storage system with the given UUID exists
(globally).</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
</ul>

<h3>PUT /v2/global/stores/:uuid</h3>

<p>Update an existing globally-defined storage system.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X PUT https://shield.host/v2/global/stores/:uuid \
     --data-binary '
{
  "name"    : "Updated Store Name",
  "summary" : "A longer description of the storage system",
  "agent"   : "127.0.0.1:5444",
  "plugin"  : "plugin",
  "config"  : {
    "new": "plugin configuration"
  }
}'
</code></pre>

<p>You can specify as many or few of these fields as you want;
omitted fields will be left at their previous values.  If <code>config</code>
is supplied, it will overwrite the value currently in the
database.</p>

<p>The values under <code>config</code> will depend entirely on which <code>plugin</code>
has been selected; no validation will be done by the SHIELD Core,
until the storage system is used in a job.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "name"    : "Updated Store Name",
  "summary" : "A longer description of the storage system",
  "agent"   : "127.0.0.1:5444",
  "plugin"  : "plugin",
  "config"  : {
    "new": "plugin configuration"
  }
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve storage system information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to update storage system</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such storage system</strong>:
No storage system with the given UUID exists
(globally).</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/global/stores/:uuid</h3>

<p>Remove a globally-defined storage system.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/global/stores/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Storage system deleted successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve storage system information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Unable to delete storage system</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>The storage system cannot be deleted at this time</strong>:
This storage system is referenced by one or more
extant job configuration; deleting it would lead to
an incomplete (and unusable) setup.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/global/policies</h3>

<p>Retrieve all defined retention policy templates.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/global/policies
</code></pre>

<ul>
<li><p><strong>?exact=(t|f)</strong>
When filtering policies, perform either exact field / value
matching (<code>exact=t</code>), or fuzzy search (<code>exact=f</code>, the
default)</p></li>
<li><p><strong>?unused=(t|f)</strong>
When filtering policies, skip those that are unused (true) or used (false)</p></li>
<li><p><strong>?name=...</strong>
Only show policies whose name matches the given value.
Subject to the <code>exact=(t|f)</code> query string parameter.</p></li>
<li><p><strong>?limit=N</strong>
Limit the returned result set to the first <em>limit</em> users
that match the other filtering rules.  A limit of <code>0</code> (the
default) denotes an unlimited search.</p></li>
</ul>

<p><strong>Response</strong></p>

<pre><code>[
  {
    "uuid"    : "f4dedf80-cdb2-4c81-9a58-b3a8282e3202",
    "name"    : "Long-Term Storage",
    "summary" : "A long-term solution, for infrequent backups only.",
    "expires" : 7776000
  }
]
</code></pre>

<p>The <code>expires</code> key is specified in seconds, but must always be a
multiple of 86400 (1 day).</p>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve retention policy templates information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
</ul>

<h3>POST /v2/global/policies</h3>

<p>Create a new retention policy template.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X POST https://shield.host/v2/global/policies \
     --data-binary '
{
  "name"    : "Retention Policy Name",
  "summary" : "A longer description of the policy",
  "expires" : 86400
}'
</code></pre>

<p>The <code>expires</code> value must be specified in seconds, and must be at
least 86,400 (1 day) and be a multiple of 86,400.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"    : "4882b332-6182-4123-984f-f9e5dd8dae20",
  "name"    : "Retention Policy Name",
  "summary" : "A longer description of the policy",
  "expires" : 86400
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Retention policy expiry must be greater than 1 day</strong>:
You supplied an <code>expires</code> value less than 86,400.
Please re-try the request with a higher value.</p></li>
<li><p><strong>Retention policy expire must be a multiple of 1 day</strong>:
You supplied an <code>expires</code> value that was not a
multiple of 86,400.  Please re-try the request with
a different value.</p></li>
<li><p><strong>Unable to create retention policy template</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>GET /v2/global/policies/:uuid</h3>

<p>Retrieve a single retention policy template.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
        https://shield.host/v2/global/policies/:uuid
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"    : "4882b332-6182-4123-984f-f9e5dd8dae20",
  "name"    : "Retention Policy Name",
  "summary" : "A longer description of the policy",
  "expires" : 86400
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve retention policy template information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such retention policy template</strong>:
No retention policy template with the given UUID
exists globally.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
</ul>

<h3>PATCH /v2/global/policies/:uuid</h3>

<p>Update a single retention policy template.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -H 'Content-Type: application/json' \
     -X PATCH https://shield.host/v2/global/policies/:uuid \
     --data-binary '
{
  "name"    : "Updated Retention Policy Name",
  "summary" : "A longer description of the retention policy",
  "expires" : 86400
}'
</code></pre>

<p>You can specify as many or few of these fields as you want;
omitted fields will be left at their previous values.</p>

<p><strong>NOTE:</strong> Updating a retention policy template will not affect any
tenants created prior to the update; updates will apply to new,
future tenants.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "uuid"    : "4882b332-6182-4123-984f-f9e5dd8dae20",
  "name"    : "Retention Policy Name",
  "summary" : "A longer description of the policy",
  "expires" : 86400
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve retention policy template information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Retention policy expiry must be greater than 1 day</strong>:
You supplied an <code>expires</code> value less than 86,400.
Please re-try the request with a higher value.</p></li>
<li><p><strong>Retention policy expire must be a multiple of 1 day</strong>:
You supplied an <code>expires</code> value that was not a
multiple of 86,400.  Please re-try the request with
a different value.</p></li>
<li><p><strong>Unable to update retention policy template</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

<h3>DELETE /v2/global/policies/:uuid</h3>

<p>Remove a retention policy template.</p>

<p><strong>NOTE:</strong> Removing a retention policy template will not affect any
tenants created prior to the removal; the template will not be
copied into any future tenants.</p>

<p><strong>Request</strong></p>

<pre><code>curl -H 'Accept: application/json' \
     -X DELETE https://shield.host/v2/global/policies/:uuid \
</code></pre>

<p>This endpoint takes no query string parameters.</p>

<p><strong>Response</strong></p>

<pre><code>{
  "ok": "Retention policy template deleted successfully"
}
</code></pre>

<p><strong>Access Control</strong></p>

<p>You must be authenticated to access this API endpoint.</p>

<p>You must also have the <code>engineer</code> system role.</p>

<p><strong>Errors</strong></p>

<p>The following error messages can be returned:</p>

<ul>
<li><p><strong>Unable to retrieve retention policy template information</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>No such retention policy template</strong>:
No retention policy with the given UUID exists on
the specified tenant.</p></li>
<li><p><strong>Unable to delete retention policy template</strong>:
an internal error occurred and should be investigated by the
site administrators</p></li>
<li><p><strong>The retention policy template cannot be deleted at this time</strong>:
This retention policy is referenced by one or more
extant job configuration; deleting it would lead to
an incomplete (and unusable) setup.  Note that this
error should never happen.</p></li>
<li><p><strong>Authorization required</strong>:
The request was made without an authenticated session or auth token.
See <strong>Authentication</strong> for more details.  The request may be retried
after authentication.</p></li>
<li><p><strong>Access denied</strong>:
The requester lacks sufficient tenant or system role assignment.
Refer to the <strong>Access Control</strong> subsection, above.
The request should not be retried.</p></li>
</ul>

